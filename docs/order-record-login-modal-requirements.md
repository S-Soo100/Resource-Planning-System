# 발주 상세 페이지 로그인 모달 요구사항

## 📋 개요

현재 `/orderRecord/[id]?teamId=xxx` URL에 비로그인 상태로 접근 시 "발주가 없다" alert 후 signin 페이지로 리다이렉트되는 문제를 해결하기 위한 로그인 모달 시스템 구현 요구사항입니다.

## 🎯 핵심 요구사항

### 1. 로그인 모달 표시

- **기존 동작**: alert("해당 발주를 찾을 수 없습니다.") 후 `/signin` 페이지로 리다이렉트
- **개선 동작**: 로그인 모달을 표시하여 사용자가 현재 페이지에서 로그인할 수 있도록 함

### 2. URL 파라미터 인식 및 팀 설정

- **teamId 파라미터 처리**: URL의 `?teamId=1` 부분을 인식하여 `selectedTeamId` 설정
- **로그인 완료 후 처리**: 로그인 성공 시 잠시 대기 후 팀 정보 설정 완료 확인

### 3. 페이지 복귀

- **자동 복귀**: 로그인 및 팀 설정 완료 후 원래 페이지(`/orderRecord/97?teamId=1`)로 자동 복귀

## 🔧 구현 세부사항

### 1. 로그인 모달 컴포넌트

#### 모달 위치

- `src/components/login/LoginModal.tsx` (새로 생성)
- 기존 `LoginForm.tsx` 컴포넌트 재사용

#### 모달 Props

```typescript
interface LoginModalProps {
  isOpen: boolean;
  onClose: () => void;
  onLoginSuccess: (userData: IUser) => void;
  redirectUrl?: string;
  teamId?: string;
}
```

### 2. 발주 상세 페이지 수정

#### 현재 파일

- `src/app/orderRecord/[id]/page.tsx`

#### 수정 사항

1. **로그인 상태 확인**: `useCurrentUser` 훅으로 로그인 상태 확인
2. **모달 상태 관리**: `useState`로 로그인 모달 표시 상태 관리
3. **URL 파라미터 추출**: `useSearchParams`로 `teamId` 추출
4. **로그인 성공 핸들러**: 로그인 완료 후 팀 설정 및 페이지 복귀 로직

### 3. 팀 설정 로직

#### AuthStore 활용

```typescript
// 로그인 성공 후 팀 설정
const handleLoginSuccess = async (userData: IUser) => {
  if (teamId) {
    // 팀 정보 설정
    authStore.getState().setSelectedTeam({ id: parseInt(teamId) });

    // 잠시 대기 후 페이지 새로고침
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  }
};
```

## 📚 참조 문서 및 규칙

### 필수 참조 문서

- `@order-system-index.md`: 발주 시스템 구조 및 비즈니스 로직
- `@llm-modification-guidelines.md`: LLM 수정 가이드라인
- `@access-level-comparison.md`: 권한 레벨 비교 및 제한사항

### 준수해야 할 규칙

#### 1. 권한 시스템 준수 (최우선)

- **4가지 권한 레벨**: "user" | "admin" | "supplier" | "moderator"
- **권한별 기능 제한**: 각 권한 레벨에 따른 발주 조회/수정 권한 확인
- **팀 기반 데이터 격리**: `teamId`를 통한 데이터 접근 제어

#### 2. 타입 안전성 유지

- **TypeScript 엄격 모드**: 모든 타입 정의 준수
- **API 응답 타입**: `ApiResponse<T>` 인터페이스 준수
- **사용자 정보 타입**: `IUser` 인터페이스의 `accessLevel` 필드 정확성

#### 3. 비즈니스 로직 보호

- **발주 워크플로우**: 상태 변경 순서 준수
- **재고 연동**: 발주-재고 연동 로직 유지
- **팀 기반 격리**: 모든 데이터는 `teamId`를 통한 격리

#### 4. UI/UX 일관성

- **권한별 UI 표시**: 권한 레벨에 따른 정확한 표시
- **반응형 디자인**: 모바일 환경 최적화 유지
- **Tailwind CSS**: 기존 스타일링 패턴 준수

## 🔄 구현 흐름

### 1. 비로그인 상태 접근 시

```
사용자가 /orderRecord/97?teamId=1 접근
↓
로그인 상태 확인 (useCurrentUser)
↓
비로그인 상태 감지
↓
로그인 모달 표시 (alert 대신)
```

### 2. 로그인 모달에서 로그인

```
로그인 모달에서 사용자 인증
↓
로그인 성공 시 onLoginSuccess 호출
↓
teamId 파라미터 추출 및 팀 설정
↓
AuthStore에 사용자 정보 및 팀 정보 저장
↓
잠시 대기 후 페이지 새로고침
```

### 3. 로그인 완료 후

```
페이지 새로고침으로 발주 데이터 재조회
↓
정상적인 발주 상세 페이지 표시
```

## ⚠️ 주의사항

### 1. 보안 고려사항

- **JWT 토큰 검증**: 로그인 상태 정확한 검증
- **권한 확인**: 발주 접근 권한 확인 필수
- **팀 접근 권한**: 사용자가 해당 팀에 속해있는지 확인

### 2. 에러 처리

- **네트워크 오류**: 로그인 실패 시 적절한 에러 메시지
- **팀 설정 실패**: teamId가 유효하지 않은 경우 처리
- **권한 부족**: 발주에 접근 권한이 없는 경우 처리

### 3. 성능 고려사항

- **캐시 무효화**: 로그인 후 관련 캐시 정확히 무효화
- **불필요한 리렌더링**: 모달 상태 변경 시 최적화
- **메모리 누수**: 모달 컴포넌트 정리 로직 포함

## 🧪 테스트 시나리오

### 1. 비로그인 상태 테스트

- [ ] `/orderRecord/97?teamId=1` 접근 시 로그인 모달 표시
- [ ] alert 대신 모달이 표시되는지 확인
- [ ] 모달 닫기 버튼 동작 확인

### 2. 로그인 성공 테스트

- [ ] 올바른 계정으로 로그인 시 성공 처리
- [ ] teamId 파라미터가 AuthStore에 설정되는지 확인
- [ ] 페이지 새로고침 후 발주 데이터 정상 표시

### 3. 권한별 테스트

- [ ] 각 권한 레벨별 발주 접근 권한 확인
- [ ] 권한이 없는 발주 접근 시 적절한 처리
- [ ] 팀 접근 권한 확인

### 4. 에러 케이스 테스트

- [ ] 잘못된 teamId 처리
- [ ] 존재하지 않는 발주 ID 처리
- [ ] 네트워크 오류 시 처리

## 📝 구현 체크리스트

### ✅ 로그인 모달 구현

- [ ] LoginModal 컴포넌트 생성
- [ ] 기존 LoginForm 컴포넌트 재사용
- [ ] 모달 열기/닫기 상태 관리
- [ ] 로그인 성공 콜백 구현

### ✅ 발주 상세 페이지 수정

- [ ] 로그인 상태 확인 로직 추가
- [ ] URL 파라미터 추출 로직 추가
- [ ] 모달 표시 조건 추가
- [ ] 로그인 성공 핸들러 구현

### ✅ 팀 설정 로직

- [ ] AuthStore 팀 설정 로직 구현
- [ ] 페이지 새로고침 타이밍 조정
- [ ] 에러 처리 로직 추가

### ✅ 테스트 및 검증

- [ ] 모든 테스트 시나리오 통과
- [ ] 권한 시스템 준수 확인
- [ ] 타입 안전성 검증
- [ ] 성능 최적화 확인

---

**⚠️ 중요**: 이 요구사항은 반드시 참조 문서의 규칙을 준수하여 구현해야 합니다. 특히 권한 시스템과 타입 안전성은 최우선으로 고려되어야 합니다.
