# ë³€ê²½ ì´ë ¥ ì‹œìŠ¤í…œ v3.0 ì—…ë°ì´íŠ¸ ê¸°íšì„œ

> **ë²„ì „**: v3.0 (íŒ€ë³„ SSE ìŠ¤íŠ¸ë¦¼ ë° ì—°ê²° ê´€ë¦¬ ì¶”ê°€)
> **ì‘ì„±ì¼**: 2025-12-22
> **ëŒ€ìƒ**: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì
> **ê´€ë ¨ ë¬¸ì„œ**:
> - [CHANGE_HISTORY_API 2.md](./CHANGE_HISTORY_API%202.md)
> - [ë³€ê²½_ì´ë ¥_í‘œì‹œ_ì‹œìŠ¤í…œ_ê¸°íšì„œ.md](./ë³€ê²½_ì´ë ¥_í‘œì‹œ_ì‹œìŠ¤í…œ_ê¸°íšì„œ.md)

---

## ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [v1.0 ëŒ€ë¹„ ë³€ê²½ì‚¬í•­](#v10-ëŒ€ë¹„-ë³€ê²½ì‚¬í•­)
3. [ì‹ ê·œ ê¸°ëŠ¥ 1: íŒ€ë³„ SSE ìŠ¤íŠ¸ë¦¼](#ì‹ ê·œ-ê¸°ëŠ¥-1-íŒ€ë³„-sse-ìŠ¤íŠ¸ë¦¼)
4. [ì‹ ê·œ ê¸°ëŠ¥ 2: SSE ì—°ê²° ê´€ë¦¬](#ì‹ ê·œ-ê¸°ëŠ¥-2-sse-ì—°ê²°-ê´€ë¦¬)
5. [êµ¬í˜„ ê³„íš](#êµ¬í˜„-ê³„íš)
6. [ë””ë ‰í† ë¦¬ êµ¬ì¡°](#ë””ë ‰í† ë¦¬-êµ¬ì¡°)
7. [ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ](#ë§ˆì´ê·¸ë ˆì´ì…˜-ê°€ì´ë“œ)

---

## ê°œìš”

### ëª©ì 

ë³€ê²½ ì´ë ¥ APIê°€ v3.0ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë©´ì„œ **íŒ€ ë‹¨ìœ„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§**ê³¼ **SSE ì—°ê²° ê´€ë¦¬** ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ê°œë³„ ì—”í‹°í‹°(Order/Demo/Item) ì¤‘ì‹¬ì˜ SSE ì™¸ì—, íŒ€ ì „ì²´ì˜ í™œë™ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.

### í•µì‹¬ ì¶”ê°€ ê¸°ëŠ¥

1. **íŒ€ë³„ SSE ìŠ¤íŠ¸ë¦¼**: íŠ¹ì • íŒ€ì˜ ëª¨ë“  ë³€ê²½ ì´ë ¥(Demo, Order, Item)ì„ í•˜ë‚˜ì˜ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ìˆ˜ì‹ 
2. **SSE ì—°ê²° ê´€ë¦¬**: Heartbeat, ì—°ê²° ì¶”ì , graceful shutdown ë“± ì•ˆì •ì ì¸ ì—°ê²° ê´€ë¦¬

### v1.0ì—ì„œ ì´ë¯¸ êµ¬í˜„ëœ ê¸°ëŠ¥

- âœ… Order/Demo/Item ê°œë³„ ë³€ê²½ ì´ë ¥ ì¡°íšŒ
- âœ… ì ‘ê¸°/í¼ì¹˜ê¸° UI
- âœ… í•„í„°ë§ ë° í˜ì´ì§€ë„¤ì´ì…˜
- âœ… ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
- âœ… ê°œë³„ ì—”í‹°í‹° SSE ìŠ¤íŠ¸ë¦¼ (ì„ì‹œ ë¹„í™œì„±í™”ë¨)

---

## v1.0 ëŒ€ë¹„ ë³€ê²½ì‚¬í•­

### API ë²„ì „ ë¹„êµ

| êµ¬ë¶„ | v1.0 | v3.0 |
|------|------|------|
| **ê°œë³„ SSE** | âœ… `/change-history/{type}/{id}/stream` | âœ… (ë™ì¼) |
| **íŒ€ë³„ SSE** | âŒ ì—†ìŒ | âœ… `/change-history/team/{teamId}/stream` |
| **íƒ€ì… í•„í„°** | âŒ ì—†ìŒ | âœ… `?types=demo,order,item` |
| **Heartbeat** | âœ… 30ì´ˆ ê°„ê²© | âœ… 30ì´ˆ ê°„ê²© (ë™ì¼) |
| **ì—°ê²° ê´€ë¦¬** | âŒ ê¸°ë³¸ ê¸°ëŠ¥ë§Œ | âœ… ê³ ê¸‰ ì—°ê²° ì¶”ì  ë° ë¡œê¹… |
| **ì´ë²¤íŠ¸ í˜•ì‹** | `{ChangeHistoryItem}` | `{entityType, entityId, teamId, ...}` |

### í”„ë¡ íŠ¸ì—”ë“œ ë³€ê²½ í•„ìš” ì‚¬í•­

| í•­ëª© | v1.0 | v3.0 ì—…ë°ì´íŠ¸ |
|------|------|--------------|
| **ê°œë³„ ì´ë ¥ ì¡°íšŒ** | âœ… êµ¬í˜„ ì™„ë£Œ | ë³€ê²½ ì—†ìŒ |
| **ê°œë³„ SSE** | âš ï¸ ì„ì‹œ ë¹„í™œì„±í™” | í™œì„±í™” ê°€ëŠ¥ (ë³€ê²½ ì—†ìŒ) |
| **íŒ€ë³„ SSE** | âŒ ì—†ìŒ | ğŸ†• **ì‹ ê·œ êµ¬í˜„ í•„ìš”** |
| **SSE í›…** | `useChangeHistorySSE` | ğŸ†• `useTeamChangeHistorySSE` ì¶”ê°€ |
| **ëŒ€ì‹œë³´ë“œ** | âŒ ì—†ìŒ | ğŸ†• **íŒ€ ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€** |

---

## ì‹ ê·œ ê¸°ëŠ¥ 1: íŒ€ë³„ SSE ìŠ¤íŠ¸ë¦¼

### ê°œìš”

íŠ¹ì • íŒ€ì— ì†í•œ **ëª¨ë“  ë³€ê²½ ì´ë ¥**(Demo, Order, Item)ì„ í•˜ë‚˜ì˜ SSE ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ìˆ˜ì‹ í•©ë‹ˆë‹¤.

### ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

#### 1. íŒ€ ëŒ€ì‹œë³´ë“œ
íŒ€ ë¦¬ë”ë‚˜ ê´€ë¦¬ìê°€ íŒ€ ì „ì²´ í™œë™ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§:
- "ìš°ë¦¬ íŒ€ì˜ ì˜¤ëŠ˜ ì£¼ë¬¸ í˜„í™©ì€?"
- "ì‹œì—° ìš”ì²­ì´ ëª‡ ê±´ ë“¤ì–´ì™”ë‚˜?"
- "ì¬ê³  ë³€ë™ ë‚´ì—­ì€?"

#### 2. ì˜ì—…íŒ€ ë‹´ë‹¹ì
ìê¸° íŒ€ì˜ ì£¼ë¬¸/ì‹œì—° ë³€ê²½ ì‚¬í•­ì„ ì‹¤ì‹œê°„ í™•ì¸:
- ìƒˆë¡œìš´ ì£¼ë¬¸ ìƒì„± ì•Œë¦¼
- ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì•Œë¦¼
- ì‹œì—° ì¼ì • ë³€ê²½ ì•Œë¦¼

### API ì—”ë“œí¬ì¸íŠ¸

```http
GET /change-history/team/:teamId/stream
```

**Query Parameters:**
- `types` (optional): í•„í„°ë§í•  íƒ€ì… (ì‰¼í‘œ êµ¬ë¶„)
  - ê¸°ë³¸ê°’: `demo,order,item` (ëª¨ë‘)
  - ì˜ˆ: `types=demo,order` (Demo, Orderë§Œ)

### ì´ë²¤íŠ¸ í˜•ì‹

#### ë³€ê²½ ì´ë²¤íŠ¸

```typescript
{
  "entityType": "order",      // "demo" | "order" | "item"
  "entityId": 123,             // í•´ë‹¹ ì—”í‹°í‹°ì˜ ID
  "teamId": 1,                 // íŒ€ ID
  "id": 456,                   // ì´ë ¥ ID
  "action": "status_change",
  "field": "status",
  "fieldLabel": "ìƒíƒœ",
  "oldValue": { "status": "ëŒ€ê¸°" },
  "newValue": { "status": "í™•ì •" },
  "userName": "í™ê¸¸ë™",
  "userEmail": "hong@example.com",
  "createdAt": "2025-12-22T12:00:00Z"
}
```

#### Heartbeat ì´ë²¤íŠ¸ (30ì´ˆ ê°„ê²©)

```typescript
{
  "type": "heartbeat",
  "timestamp": "2025-12-22T12:00:30Z"
}
```

### TypeScript íƒ€ì… ì •ì˜

**íŒŒì¼**: `src/types/change-history.ts` (ê¸°ì¡´ íŒŒì¼ í™•ì¥)

```typescript
/**
 * íŒ€ë³„ SSE ì´ë²¤íŠ¸ (v3.0)
 */
export type EntityType = 'demo' | 'order' | 'item';

export interface TeamHistoryEvent {
  entityType: EntityType;
  entityId: number;
  teamId: number;
  id: number;
  action: ChangeAction;
  field?: string;
  fieldLabel?: string;
  oldValue?: Record<string, any>;
  newValue?: Record<string, any>;
  userName: string;
  userEmail: string;
  accessLevel: AccessLevel;
  remarks?: string;
  createdAt: string;
}

export interface HeartbeatEvent {
  type: 'heartbeat';
  timestamp: string;
}

export type TeamSSEEvent = TeamHistoryEvent | HeartbeatEvent;
```

### React í›… êµ¬í˜„

**íŒŒì¼**: `src/hooks/useTeamChangeHistorySSE.ts` (ì‹ ê·œ)

```typescript
/**
 * íŒ€ë³„ ë³€ê²½ ì´ë ¥ SSE í›… (v3.0)
 */
import { useEffect, useRef } from 'react';
import { useQueryClient } from '@tanstack/react-query';
import { message } from 'antd';
import { getToken } from '@/api/cookie-api';
import type { TeamSSEEvent, TeamHistoryEvent, EntityType } from '@/types/change-history';
import { getActionLabel } from '@/utils/changeHistory';

export interface UseTeamChangeHistorySSEOptions {
  /** í™œì„±í™” ì—¬ë¶€ */
  enabled?: boolean;
  /** í•„í„°ë§í•  ì—”í‹°í‹° íƒ€ì… */
  types?: EntityType[];
  /** ë³€ê²½ ì´ë²¤íŠ¸ ì½œë°± */
  onEvent?: (event: TeamHistoryEvent) => void;
  /** Heartbeat ì½œë°± */
  onHeartbeat?: (timestamp: string) => void;
  /** ì—ëŸ¬ ì½œë°± */
  onError?: (error: Event) => void;
}

export const useTeamChangeHistorySSE = (
  teamId: number,
  options: UseTeamChangeHistorySSEOptions = {}
) => {
  const {
    enabled = true,
    types,
    onEvent,
    onHeartbeat,
    onError,
  } = options;

  const queryClient = useQueryClient();
  const eventSourceRef = useRef<EventSource | null>(null);

  useEffect(() => {
    if (!enabled || !teamId) return;

    const token = getToken();
    if (!token) {
      console.warn('[Team SSE] í† í°ì´ ì—†ì–´ ì—°ê²°í•˜ì§€ ì•ŠìŒ');
      return;
    }

    // URL ìƒì„±
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';
    const typesParam = types ? `?types=${types.join(',)}` : '';
    const sseUrl = `${apiUrl}/change-history/team/${teamId}/stream${typesParam}`;

    console.log(`[Team SSE] ì—°ê²° ì‹œì‘: Team ${teamId}`, types || 'all types');

    // EventSource ìƒì„±
    const eventSource = new EventSource(sseUrl, {
      withCredentials: true,
    });
    eventSourceRef.current = eventSource;

    // ì—°ê²° ì„±ê³µ
    eventSource.addEventListener('open', () => {
      console.log(`[Team SSE] ì—°ê²° ì„±ê³µ: Team ${teamId}`);
    });

    // ë©”ì‹œì§€ ìˆ˜ì‹  (ë³€ê²½ + heartbeat)
    eventSource.onmessage = (event) => {
      try {
        const data: TeamSSEEvent = JSON.parse(event.data);

        // Heartbeat ì²˜ë¦¬
        if ('type' in data && data.type === 'heartbeat') {
          console.log(`[Team SSE] Heartbeat:`, data.timestamp);
          onHeartbeat?.(data.timestamp);
          return;
        }

        // ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬
        const teamEvent = data as TeamHistoryEvent;
        console.log(`[Team SSE] ë³€ê²½ ì´ë²¤íŠ¸:`, teamEvent);

        // ì½œë°± ì‹¤í–‰
        onEvent?.(teamEvent);

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        message.info({
          content: `[${getEntityTypeLabel(teamEvent.entityType)}] ${teamEvent.userName}ë‹˜ì´ ${getActionLabel(teamEvent.action)}í–ˆìŠµë‹ˆë‹¤`,
          duration: 3,
        });

        // React Query ìºì‹œ ë¬´íš¨í™” (ì„ íƒì )
        // queryClient.invalidateQueries(['teamChangeHistory', teamId]);
      } catch (error) {
        console.error('[Team SSE] ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
      }
    };

    // ì—ëŸ¬ ì²˜ë¦¬
    eventSource.onerror = (error) => {
      console.error(`[Team SSE] ì—°ê²° ì˜¤ë¥˜:`, error);
      onError?.(error);

      if (eventSource.readyState === EventSource.CLOSED) {
        console.log('[Team SSE] ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    };

    // Cleanup
    return () => {
      if (eventSourceRef.current) {
        console.log(`[Team SSE] ì—°ê²° ì¢…ë£Œ: Team ${teamId}`);
        eventSourceRef.current.close();
        eventSourceRef.current = null;
      }
    };
  }, [teamId, enabled, types, queryClient, onEvent, onHeartbeat, onError]);

  return {
    isConnected: eventSourceRef.current?.readyState === EventSource.OPEN,
  };
};

/**
 * ì—”í‹°í‹° íƒ€ì…ë³„ í•œê¸€ ë¼ë²¨
 */
const getEntityTypeLabel = (type: EntityType): string => {
  switch (type) {
    case 'demo':
      return 'ì‹œì—°';
    case 'order':
      return 'ì£¼ë¬¸';
    case 'item':
      return 'ì¬ê³ ';
    default:
      return type;
  }
};
```

### ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€

**íŒŒì¼**: `src/utils/changeHistory.ts` (ê¸°ì¡´ íŒŒì¼ í™•ì¥)

```typescript
import type { EntityType } from '@/types/change-history';

/**
 * ì—”í‹°í‹° íƒ€ì…ë³„ í•œê¸€ ë¼ë²¨ ë°˜í™˜
 */
export const getEntityTypeLabel = (type: EntityType): string => {
  switch (type) {
    case 'demo':
      return 'ì‹œì—°';
    case 'order':
      return 'ì£¼ë¬¸';
    case 'item':
      return 'ì¬ê³ ';
    default:
      return type;
  }
};

/**
 * ì—”í‹°í‹° íƒ€ì…ë³„ ìƒ‰ìƒ ë°˜í™˜
 */
export const getEntityTypeColor = (type: EntityType): string => {
  switch (type) {
    case 'demo':
      return 'purple';
    case 'order':
      return 'blue';
    case 'item':
      return 'orange';
    default:
      return 'default';
  }
};

/**
 * ì—”í‹°í‹° íƒ€ì…ë³„ ì•„ì´ì½˜ ë°˜í™˜
 */
export const getEntityTypeIcon = (type: EntityType): React.ReactNode => {
  switch (type) {
    case 'demo':
      return <CalendarOutlined />;
    case 'order':
      return <ShoppingCartOutlined />;
    case 'item':
      return <InboxOutlined />;
    default:
      return <InfoCircleOutlined />;
  }
};
```

### íŒ€ ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/team/TeamActivityDashboard.tsx` (ì‹ ê·œ)

```tsx
/**
 * íŒ€ í™œë™ ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸
 */
'use client';

import React, { useState } from 'react';
import { Card, Tag, Timeline, Checkbox, Empty, Spin } from 'antd';
import { TeamOutlined } from '@ant-design/icons';
import { useTeamChangeHistorySSE } from '@/hooks/useTeamChangeHistorySSE';
import type { TeamHistoryEvent, EntityType } from '@/types/change-history';
import {
  getEntityTypeLabel,
  getEntityTypeColor,
  getEntityTypeIcon,
  getActionLabel,
  getActionColor,
  formatDateTime,
} from '@/utils/changeHistory';

interface TeamActivityDashboardProps {
  teamId: number;
  teamName: string;
}

const TeamActivityDashboard: React.FC<TeamActivityDashboardProps> = ({
  teamId,
  teamName,
}) => {
  const [events, setEvents] = useState<TeamHistoryEvent[]>([]);
  const [selectedTypes, setSelectedTypes] = useState<EntityType[]>(['demo', 'order', 'item']);
  const [isConnecting, setIsConnecting] = useState(true);

  // íŒ€ë³„ SSE ì—°ê²°
  const { isConnected } = useTeamChangeHistorySSE(teamId, {
    enabled: true,
    types: selectedTypes,
    onEvent: (event) => {
      // ìƒˆ ì´ë²¤íŠ¸ë¥¼ ë¦¬ìŠ¤íŠ¸ ë§¨ ì•ì— ì¶”ê°€ (ìµœì‹ ìˆœ)
      setEvents((prev) => [event, ...prev].slice(0, 50)); // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ìœ ì§€
      setIsConnecting(false);
    },
    onHeartbeat: () => {
      setIsConnecting(false);
    },
    onError: () => {
      setIsConnecting(false);
    },
  });

  // íƒ€ì… í•„í„° ë³€ê²½
  const handleTypeChange = (checkedValues: EntityType[]) => {
    setSelectedTypes(checkedValues);
    setEvents([]); // í•„í„° ë³€ê²½ ì‹œ ê¸°ì¡´ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
  };

  return (
    <Card
      title={
        <div className="flex items-center justify-between">
          <span className="flex items-center gap-2">
            <TeamOutlined />
            {teamName} ì‹¤ì‹œê°„ í™œë™
          </span>
          <div className="flex items-center gap-2">
            <Tag color={isConnected ? 'green' : 'red'}>
              {isConnected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ì¤‘...'}
            </Tag>
          </div>
        </div>
      }
      className="mb-6"
    >
      {/* íƒ€ì… í•„í„° */}
      <div className="mb-4">
        <Checkbox.Group
          value={selectedTypes}
          onChange={handleTypeChange as any}
        >
          <Checkbox value="demo">ì‹œì—°</Checkbox>
          <Checkbox value="order">ì£¼ë¬¸</Checkbox>
          <Checkbox value="item">ì¬ê³ </Checkbox>
        </Checkbox.Group>
      </div>

      {/* ë¡œë”© ìƒíƒœ */}
      {isConnecting && (
        <div className="text-center py-8">
          <Spin />
          <p className="mt-2 text-gray-500">ì‹¤ì‹œê°„ ì—°ê²° ì¤‘...</p>
        </div>
      )}

      {/* ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ */}
      {!isConnecting && events.length === 0 && (
        <Empty
          description="ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤"
          image={Empty.PRESENTED_IMAGE_SIMPLE}
        />
      )}

      {!isConnecting && events.length > 0 && (
        <Timeline
          items={events.map((event) => ({
            color: getActionColor(event.action),
            dot: getEntityTypeIcon(event.entityType),
            children: (
              <div key={event.id} className="mb-2">
                {/* ì—”í‹°í‹° íƒ€ì… + ì•¡ì…˜ */}
                <div className="flex items-center gap-2 mb-1">
                  <Tag color={getEntityTypeColor(event.entityType)}>
                    {getEntityTypeLabel(event.entityType)}
                  </Tag>
                  <Tag color={getActionColor(event.action)}>
                    {getActionLabel(event.action)}
                  </Tag>
                  <span className="text-gray-500 text-sm">
                    {formatDateTime(event.createdAt)}
                  </span>
                </div>

                {/* ë³€ê²½ ë‚´ìš© */}
                {event.fieldLabel && (
                  <div className="text-sm mb-1">
                    <span className="font-semibold">{event.fieldLabel}</span> ë³€ê²½
                  </div>
                )}

                {/* ì‘ì—…ì */}
                <div className="text-sm text-gray-600">
                  {event.userName}ë‹˜ì´ ë³€ê²½í–ˆìŠµë‹ˆë‹¤
                </div>

                {/* ë¹„ê³  */}
                {event.remarks && (
                  <div className="mt-1 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                    ğŸ’¬ {event.remarks}
                  </div>
                )}
              </div>
            ),
          }))}
        />
      )}
    </Card>
  );
};

export default TeamActivityDashboard;
```

---

## ì‹ ê·œ ê¸°ëŠ¥ 2: SSE ì—°ê²° ê´€ë¦¬

### ê°œìš”

v3.0ì—ì„œëŠ” SSE ì—°ê²°ì˜ ì•ˆì •ì„±ê³¼ ì¶”ì ì„±ì„ ê°•í™”í•˜ê¸° ìœ„í•´ ê³ ê¸‰ ì—°ê²° ê´€ë¦¬ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥

#### 1. Heartbeat ë©”ì»¤ë‹ˆì¦˜

| í•­ëª© | ì„¤ì •ê°’ | ì„¤ëª… |
| ---- | ------ | ---- |
| ê°„ê²© | 30ì´ˆ | ì—°ê²° ìœ ì§€ í™•ì¸ |
| ì´ë²¤íŠ¸ íƒ€ì… | heartbeat | í´ë¼ì´ì–¸íŠ¸ì—ì„œ êµ¬ë¶„ ê°€ëŠ¥ |
| ë°ì´í„° | timestamp | ì„œë²„ ì‹œê°„ ì „ì†¡ |

**í”„ë¡ íŠ¸ì—”ë“œ ì²˜ë¦¬:**

```typescript
eventSource.addEventListener('heartbeat', (event) => {
  const data = JSON.parse(event.data);
  console.log('ì—°ê²° ìœ ì§€ ì¤‘:', data.timestamp);

  // ë§ˆì§€ë§‰ heartbeat ì‹œê°„ ì—…ë°ì´íŠ¸ (ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ìš©)
  setLastHeartbeat(new Date(data.timestamp));
});
```

#### 2. ì—°ê²° ì¶”ì 

ì„œë²„ëŠ” ëª¨ë“  í™œì„± SSE ì—°ê²°ì„ ì¶”ì í•©ë‹ˆë‹¤:

| í•­ëª© | ì„¤ëª… |
| ---- | ---- |
| ì—°ê²° ID | UUIDë¡œ ê° ì—°ê²° ê³ ìœ  ì‹ë³„ |
| íŒ€ ID | êµ¬ë… ì¤‘ì¸ íŒ€ (íŒ€ë³„ ìŠ¤íŠ¸ë¦¼ì¸ ê²½ìš°) |
| ì‚¬ìš©ì ID | ì—°ê²°í•œ ì‚¬ìš©ì |
| ì—°ê²° ì‹œì‘ ì‹œê°„ | ì—°ê²° ìœ ì§€ ì‹œê°„ ê³„ì‚°ìš© |

**í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” ì‹ ê²½ ì“¸ í•„ìš” ì—†ìŒ** - ì„œë²„ì—ì„œ ìë™ ê´€ë¦¬

#### 3. Graceful Shutdown

ì„œë²„ ì¬ì‹œì‘ ì‹œ ëª¨ë“  ì—°ê²°ì´ ì•ˆì „í•˜ê²Œ ì¢…ë£Œë©ë‹ˆë‹¤.

**í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ì‘:**

```typescript
eventSource.onerror = (error) => {
  console.error('SSE ì—°ê²° ì˜¤ë¥˜:', error);

  if (eventSource.readyState === EventSource.CLOSED) {
    console.log('ì„œë²„ê°€ ì—°ê²°ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì‹œë„ ì¤‘...');
    // EventSourceëŠ” ìë™ìœ¼ë¡œ ì¬ì—°ê²° ì‹œë„í•¨
  }
};
```

### ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/common/SSEConnectionStatus.tsx` (ì‹ ê·œ)

```tsx
/**
 * SSE ì—°ê²° ìƒíƒœ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
 */
'use client';

import React, { useState, useEffect } from 'react';
import { Tag } from 'antd';
import { CheckCircleOutlined, CloseCircleOutlined, SyncOutlined } from '@ant-design/icons';

interface SSEConnectionStatusProps {
  isConnected: boolean;
  lastHeartbeat?: Date;
}

const SSEConnectionStatus: React.FC<SSEConnectionStatusProps> = ({
  isConnected,
  lastHeartbeat,
}) => {
  const [isStale, setIsStale] = useState(false);

  // Heartbeat ì‹œê°„ ì²´í¬ (60ì´ˆ ì´ìƒ ì—†ìœ¼ë©´ ì—°ê²° ë¶ˆì•ˆì •)
  useEffect(() => {
    if (!lastHeartbeat) return;

    const interval = setInterval(() => {
      const now = new Date();
      const diff = (now.getTime() - lastHeartbeat.getTime()) / 1000;
      setIsStale(diff > 60);
    }, 1000);

    return () => clearInterval(interval);
  }, [lastHeartbeat]);

  if (!isConnected) {
    return (
      <Tag icon={<CloseCircleOutlined />} color="error">
        ì—°ê²° ëŠê¹€
      </Tag>
    );
  }

  if (isStale) {
    return (
      <Tag icon={<SyncOutlined spin />} color="warning">
        ì—°ê²° ë¶ˆì•ˆì •
      </Tag>
    );
  }

  return (
    <Tag icon={<CheckCircleOutlined />} color="success">
      ì—°ê²°ë¨
    </Tag>
  );
};

export default SSEConnectionStatus;
```

---

## êµ¬í˜„ ê³„íš

### Phase 1: íƒ€ì… ë° ìœ í‹¸ë¦¬í‹° í™•ì¥ (í•„ìˆ˜)

- [ ] `src/types/change-history.ts` í™•ì¥
  - [ ] `EntityType` íƒ€ì… ì¶”ê°€
  - [ ] `TeamHistoryEvent` ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€
  - [ ] `HeartbeatEvent` ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€
  - [ ] `TeamSSEEvent` ìœ ë‹ˆì˜¨ íƒ€ì… ì¶”ê°€

- [ ] `src/utils/changeHistory.ts` í™•ì¥
  - [ ] `getEntityTypeLabel()` í•¨ìˆ˜ ì¶”ê°€
  - [ ] `getEntityTypeColor()` í•¨ìˆ˜ ì¶”ê°€
  - [ ] `getEntityTypeIcon()` í•¨ìˆ˜ ì¶”ê°€

### Phase 2: íŒ€ë³„ SSE í›… êµ¬í˜„ (í•„ìˆ˜)

- [ ] `src/hooks/useTeamChangeHistorySSE.ts` ìƒì„±
  - [ ] íŒ€ë³„ SSE ì—°ê²° ë¡œì§
  - [ ] íƒ€ì… í•„í„°ë§ ì§€ì›
  - [ ] ì´ë²¤íŠ¸/Heartbeat/ì—ëŸ¬ ì½œë°±
  - [ ] ìë™ ì¬ì—°ê²° ì²˜ë¦¬

### Phase 3: íŒ€ ëŒ€ì‹œë³´ë“œ ì»´í¬ë„ŒíŠ¸ (í•„ìˆ˜)

- [ ] `src/components/team/TeamActivityDashboard.tsx` ìƒì„±
  - [ ] ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸
  - [ ] íƒ€ì… í•„í„° ì²´í¬ë°•ìŠ¤
  - [ ] ì—°ê²° ìƒíƒœ í‘œì‹œ
  - [ ] Timeline í˜•ì‹ UI

- [ ] `src/components/common/SSEConnectionStatus.tsx` ìƒì„±
  - [ ] ì—°ê²° ìƒíƒœ íƒœê·¸
  - [ ] Heartbeat ëª¨ë‹ˆí„°ë§

### Phase 4: í˜ì´ì§€ í†µí•© (í•„ìˆ˜)

- [ ] íŒ€ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ìƒì„± ë˜ëŠ” ê¸°ì¡´ í˜ì´ì§€ì— ì¶”ê°€
  - ê°€ëŠ¥í•œ ìœ„ì¹˜:
    - ìƒˆ í˜ì´ì§€: `src/app/team-dashboard/page.tsx`
    - ê¸°ì¡´ í˜ì´ì§€ í™•ì¥: ë©”ì¸ ëŒ€ì‹œë³´ë“œì— ì„¹ì…˜ ì¶”ê°€

### Phase 5: ê¸°ì¡´ SSE í™œì„±í™” (ì„ íƒ)

- [ ] ê°œë³„ ì—”í‹°í‹° SSE ì£¼ì„ í•´ì œ
  - [ ] `OrderChangeHistory.tsx` (11, 37ë¼ì¸)
  - [ ] `DemoChangeHistory.tsx` (11, 37ë¼ì¸)
  - [ ] `ItemQuantityHistory.tsx` (11, 39ë¼ì¸)

### Phase 6: í…ŒìŠ¤íŠ¸ ë° ìµœì í™”

- [ ] SSE ì—°ê²° í…ŒìŠ¤íŠ¸
  - [ ] íŒ€ë³„ ìŠ¤íŠ¸ë¦¼ ì—°ê²° í™•ì¸
  - [ ] íƒ€ì… í•„í„°ë§ ë™ì‘ í™•ì¸
  - [ ] Heartbeat ìˆ˜ì‹  í™•ì¸
  - [ ] ìë™ ì¬ì—°ê²° í™•ì¸

- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  - [ ] ë‹¤ìˆ˜ì˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
  - [ ] ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ í™•ì¸
  - [ ] ì—°ê²° ì¢…ë£Œ ì‹œ ì •ë¦¬ í™•ì¸

---

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ change-history.ts                 # í™•ì¥ (TeamHistoryEvent ë“± ì¶”ê°€)
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useChangeHistory.ts               # ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ)
â”‚   â”œâ”€â”€ useChangeHistorySSE.ts            # ê¸°ì¡´ (ê°œë³„ SSE, ì„ì‹œ ë¹„í™œì„±í™”)
â”‚   â””â”€â”€ useTeamChangeHistorySSE.ts        # ğŸ†• ì‹ ê·œ (íŒ€ë³„ SSE)
â”‚
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ changeHistory.ts                  # í™•ì¥ (getEntityType* í•¨ìˆ˜ ì¶”ê°€)
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ ChangeHistoryItem.tsx         # ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ)
â”‚   â”‚   â””â”€â”€ SSEConnectionStatus.tsx       # ğŸ†• ì‹ ê·œ (ì—°ê²° ìƒíƒœ í‘œì‹œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ team/
â”‚   â”‚   â””â”€â”€ TeamActivityDashboard.tsx     # ğŸ†• ì‹ ê·œ (íŒ€ ëŒ€ì‹œë³´ë“œ)
â”‚   â”‚
â”‚   â”œâ”€â”€ orderRecord/
â”‚   â”‚   â””â”€â”€ OrderChangeHistory.tsx        # ê¸°ì¡´ (SSE í™œì„±í™” ê°€ëŠ¥)
â”‚   â”‚
â”‚   â”œâ”€â”€ demonstration/
â”‚   â”‚   â””â”€â”€ DemoChangeHistory.tsx         # ê¸°ì¡´ (SSE í™œì„±í™” ê°€ëŠ¥)
â”‚   â”‚
â”‚   â””â”€â”€ item/
â”‚       â””â”€â”€ ItemQuantityHistory.tsx       # ê¸°ì¡´ (SSE í™œì„±í™” ê°€ëŠ¥)
â”‚
â””â”€â”€ app/
    â”œâ”€â”€ team-dashboard/                   # ğŸ†• ì‹ ê·œ (íŒ€ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€)
    â”‚   â””â”€â”€ page.tsx
    â”‚
    â”œâ”€â”€ orderRecord/[id]/
    â”‚   â””â”€â”€ page.tsx                      # ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ)
    â”‚
    â”œâ”€â”€ demoRecord/[id]/
    â”‚   â””â”€â”€ page.tsx                      # ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ)
    â”‚
    â””â”€â”€ item/[id]/
        â””â”€â”€ page.tsx                      # ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ)
```

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

### ê¸°ì¡´ ì½”ë“œì— ì˜í–¥ ì—†ìŒ

v3.0 ì—…ë°ì´íŠ¸ëŠ” **ì™„ì „íˆ í•˜ìœ„ í˜¸í™˜**ë©ë‹ˆë‹¤:

- âœ… ê¸°ì¡´ ì¡°íšŒ APIëŠ” ë³€ê²½ ì—†ìŒ
- âœ… ê¸°ì¡´ ê°œë³„ SSE APIëŠ” ë³€ê²½ ì—†ìŒ
- âœ… ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ëŠ” ìˆ˜ì • ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥

### ìƒˆë¡œìš´ ê¸°ëŠ¥ë§Œ ì¶”ê°€

v3.0ì˜ ìƒˆ ê¸°ëŠ¥ì€ **ì„ íƒì ìœ¼ë¡œ ì¶”ê°€**í•˜ë©´ ë©ë‹ˆë‹¤:

1. **íŒ€ ëŒ€ì‹œë³´ë“œê°€ í•„ìš”í•œ ê²½ìš°**: Phase 1~4 êµ¬í˜„
2. **ê°œë³„ SSEë§Œ í™œì„±í™”í•˜ê³  ì‹¶ì€ ê²½ìš°**: Phase 5ë§Œ ì§„í–‰
3. **ëª¨ë“  ê¸°ëŠ¥ ì‚¬ìš©**: Phase 1~6 ì „ì²´ êµ¬í˜„

### ë‹¨ê³„ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜

#### Step 1: íƒ€ì… í™•ì¥ (ì˜í–¥ ì—†ìŒ)

```typescript
// src/types/change-history.tsì— ì¶”ê°€ë§Œ í•˜ë©´ ë¨
export type EntityType = 'demo' | 'order' | 'item';
export interface TeamHistoryEvent { ... }
```

#### Step 2: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€ (ì˜í–¥ ì—†ìŒ)

```typescript
// src/utils/changeHistory.tsì— ì¶”ê°€ë§Œ í•˜ë©´ ë¨
export const getEntityTypeLabel = (type: EntityType) => { ... };
```

#### Step 3: ìƒˆ í›… ìƒì„± (ê¸°ì¡´ í›…ê³¼ ë…ë¦½ì )

```typescript
// src/hooks/useTeamChangeHistorySSE.ts ìƒˆë¡œ ìƒì„±
// ê¸°ì¡´ useChangeHistorySSE.tsëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
```

#### Step 4: ìƒˆ ì»´í¬ë„ŒíŠ¸ ìƒì„± (ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ì™€ ë…ë¦½ì )

```typescript
// src/components/team/TeamActivityDashboard.tsx ìƒˆë¡œ ìƒì„±
// ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
```

#### Step 5: ê°œë³„ SSE í™œì„±í™” (ì„ íƒ)

```typescript
// ê¸°ì¡´ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì£¼ì„ë§Œ í•´ì œ
// OrderChangeHistory.tsx
- // import { useChangeHistorySSE } from '@/hooks/useChangeHistorySSE';
+ import { useChangeHistorySSE } from '@/hooks/useChangeHistorySSE';

- // const { isConnected } = useChangeHistorySSE('order', orderId, isExpanded);
+ const { isConnected } = useChangeHistorySSE('order', orderId, isExpanded);
```

---

## ì°¸ê³  ì‚¬í•­

### 1. SSE ë¸Œë¼ìš°ì € ì§€ì›

- âœ… Chrome, Firefox, Safari, Edge ëª¨ë‘ ì§€ì›
- âŒ IE11 ë¯¸ì§€ì› (í•˜ì§€ë§Œ KARSëŠ” ëª¨ë˜ ë¸Œë¼ìš°ì €ë§Œ ì§€ì›)

### 2. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

- íŒ€ë³„ SSEëŠ” **íŒ€ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ** ì‚¬ìš© ê¶Œì¥
- ê°œë³„ í˜ì´ì§€ì—ì„œëŠ” **ê°œë³„ SSE** ì‚¬ìš©
- ë¶ˆí•„ìš”í•œ ì—°ê²°ì€ ì¦‰ì‹œ `close()` í˜¸ì¶œ

### 3. ë³´ì•ˆ

- SSEëŠ” HTTP ê¸°ë°˜ì´ë¯€ë¡œ HTTPS í™˜ê²½ì—ì„œë§Œ ì•ˆì „
- í† í° ë§Œë£Œ ì‹œ ì¬ì¸ì¦ í•„ìš”
- EventSourceëŠ” ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì „ì†¡ (`withCredentials: true`)

### 4. ë””ë²„ê¹…

```typescript
// ê°œë°œ í™˜ê²½ì—ì„œ ìƒì„¸ ë¡œê·¸
if (process.env.NODE_ENV === 'development') {
  eventSource.addEventListener('open', () => {
    console.log('[SSE] ì—°ê²° ì„±ê³µ');
  });

  eventSource.addEventListener('error', (error) => {
    console.error('[SSE] ì—ëŸ¬:', error);
  });
}
```

---

## ë¬¸ì˜

- í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œíŒ€
- ë°±ì—”ë“œ API: ë°±ì—”ë“œ ê°œë°œíŒ€
- ê¸°íš ìˆ˜ì •: PM
